--------------------------------------------------------------
----Averages for Contacts


	--For IET avg therapist time per contact
IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_IETContacts]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_IETContacts]
SELECT
*
,ROW_NUMBER() OVER(PARTITION BY PathwayID ORDER BY StartDateIntEnabledTherLog desc) as LatestContactRank
INTO [MHDInternal].[TEMP_TTAD_IET_IETContacts]	
FROM(
	SELECT DISTINCT
		i.PathwayID
		,i.StartDateIntEnabledTherLog
		,i.EndDateIntEnabledTherLog
		,i.DurationIntEnabledTher
		,i.Unique_MonthID
	
	FROM [mesh_IAPT].[IDS205internettherlog] i
	INNER JOIN [mesh_IAPT].[IsLatest_SubmissionID] l ON i.[UniqueSubmissionID] = l.[UniqueSubmissionID] AND i.[AuditId] = l.[AuditId]
	WHERE l.IsLatest = 1
)_


--For all contacts average therapist time per contact
IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_AllContacts]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_AllContacts]
SELECT
*
,ROW_NUMBER() OVER(PARTITION BY PathwayID ORDER BY CareContDate desc) as LatestContactRank
INTO [MHDInternal].[TEMP_TTAD_IET_AllContacts]
FROM(
SELECT DISTINCT
    c.PathwayID
	,c.CareContDate
    ,ca.ClinContactDurOfCareAct
	,c.Unique_MonthID
FROM [mesh_IAPT].[IDS201carecontact] c
INNER JOIN [mesh_IAPT].[IsLatest_SubmissionID] l ON c.[UniqueSubmissionID] = l.[UniqueSubmissionID] AND c.[AuditId] = l.[AuditId]
LEFT JOIN [mesh_IAPT].[IDS202careactivity] ca ON ca.PathwayID=c.PathwayID AND ca.UniqueSubmissionID=c.UniqueSubmissionID
AND ca.AuditId=c.AuditId
WHERE l.IsLatest = 1
)_

IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_Base2]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_Base2]
SELECT DISTINCT
	b.Month
	,b.PathwayID

	--Number of Appointments
    ,b.InternetEnabledTherapy_Count

	--Contact dates
	,i.StartDateIntEnabledTherLog

	--Therapist Time
	,i.DurationIntEnabledTher

	,CASE WHEN i.LatestContactRank=1 OR i.LatestContactRank IS NULL THEN b.CompTreatFlag ELSE NULL 
	END AS CompTreatFlag --Flag for completed treatment flag, where the discharge date is within the reporting period
    
    --Geography
    ,b.[Sub-ICBCode]
	,b.[Sub-ICBName]
	,b.ICBCode
	,b.ICBName
	,b.RegionNameComm
	,b.RegionCodeComm
	,b.ProviderCode
	,b.ProviderName
	,b.RegionNameProv
INTO [MHDInternal].[TEMP_TTAD_IET_Base2]
FROM [MHDInternal].[TEMP_TTAD_IET_Base] b
LEFT JOIN [MHDInternal].[TEMP_TTAD_IET_IETContacts] i ON i.PathwayID = b.PathwayID 


IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_Base3]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_Base3]
SELECT DISTINCT
	b.Month
	,b.PathwayID

	--Number of Appointments
    ,b.InternetEnabledTherapy_Count

	--Contact dates
	,ca.CareContDate

	--Therapist Time
	,ca.ClinContactDurOfCareAct

	,CASE WHEN ca.LatestContactRank=1 OR ca.LatestContactRank IS NULL THEN b.CompTreatFlag ELSE NULL 
	END AS CompTreatFlag --Flag for completed treatment flag, where the discharge date is within the reporting period
    
    --Geography
    ,b.[Sub-ICBCode]
	,b.[Sub-ICBName]
	,b.ICBCode
	,b.ICBName
	,b.RegionNameComm
	,b.RegionCodeComm
	,b.ProviderCode
	,b.ProviderName
	,b.RegionNameProv
INTO [MHDInternal].[TEMP_TTAD_IET_Base3]
FROM [MHDInternal].[TEMP_TTAD_IET_Base] b
LEFT JOIN [MHDInternal].[TEMP_TTAD_IET_AllContacts] ca ON ca.PathwayID=b.PathwayID


IF OBJECT_ID ('[MHDInternal].[DASHBOARD_TTAD_IET_AvgTherapistTime]') IS NOT NULL DROP TABLE [MHDInternal].[DASHBOARD_TTAD_IET_AvgTherapistTime]
--National, IET 1+
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,CAST('1+ IET' AS VARCHAR(50)) AS AppointmentType
,InternetEnabledTherapy_Count
,DurationIntEnabledTher AS AvgIETTherapistTime
,ClinContactDurOfCareAct AS ClinicalTherapistTime
--,ConsultationMedium
,IntegratedSoftwareInd
,EndCode
,EndCodeDescription
,ProblemDescriptor
,WaitRefToFirstAssess
,WaitRefToFirstTherapy
,WaitFirstTherapyToSecondTherapy
,SUM(CompTreatFlagRecFlag) AS CompTreatFlagRecFlag
,SUM(CompTreatFlagNotCasenessFlag) AS CompTreatFlagNotCasenessFlag
,SUM(CompTreatFlagRelImpFlag) AS CompTreatFlagRelImpFlag
,SUM(CompTreatFlagRelRecFlags) AS CompTreatFlagRelRecFlags
,SUM(CompTreatFlag) AS CompTreatFlag
INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgTherapistTime]
FROM [MHDInternal].[TEMP_TTAD_IET_Base2]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,InternetEnabledTherapy_Count
	,IntEnabledTherProg
	,DurationIntEnabledTher
	,ClinContactDurOfCareAct
	--,ConsultationMedium
	,IntegratedSoftwareInd
	,EndCode
	,EndCodeDescription
	,ProblemDescriptor
	,WaitRefToFirstAssess
	,WaitRefToFirstTherapy
	,WaitFirstTherapyToSecondTherapy
GO

