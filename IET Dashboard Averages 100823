
--Avg Waits, Avg Appointments per course of treatment, Avg Therapist Time per course of treatment

IF OBJECT_ID ('[MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]') IS NOT NULL DROP TABLE [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
--National, IET 1+
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,CAST('1+ IET' AS VARCHAR(50)) AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,IntEnabledTherProg
GO

--National, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,IntEnabledTherProg


--National, IET 2+
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,IntEnabledTherProg

--Region, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm AS OrgName
,RegionCodeComm AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm
	,IntEnabledTherProg


--Region, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg


--Region, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg

--ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg

--ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--Sub-ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Provider, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AverageWaits]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(InternetEnabledTherapy_Count) AS AverageNumberofIETAppointmentsPerTreatment
,AVG(DurationIntEnabledTher) AS AverageIETTherapistTimePerTreatment
,AVG(ClinContactDurOfCareAct) AS AverageAnyTherapistTimePerTreatment
,AVG(WaitRefToFirstAssess) AS AverageWaitFromReferralToFirstAssessment
,AVG(WaitRefToFirstTherapy) AS AverageWaitFromReferralToFirstTherapy
,AVG(WaitFirstTherapyToSecondTherapy) AS AverageWaitFromFirstTherapyToSecondTherapy
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_Base]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg


---------------------------------------------------------------
--Average therapist time per contact for IETs and for any contact

----Average IET Contacts

--For IET average therapist time per contact
IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_IETContacts]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_IETContacts]
SELECT
*
,ROW_NUMBER() OVER(PARTITION BY PathwayID ORDER BY StartDateIntEnabledTherLog desc) as LatestContactRank
INTO [MHDInternal].[TEMP_TTAD_IET_IETContacts]	
FROM(
	SELECT DISTINCT
		i.PathwayID
		,i.StartDateIntEnabledTherLog
		,i.EndDateIntEnabledTherLog
		,i.DurationIntEnabledTher
		,i.Unique_MonthID
	
	FROM [mesh_IAPT].[IDS205internettherlog] i
	INNER JOIN [mesh_IAPT].[IsLatest_SubmissionID] l ON i.[UniqueSubmissionID] = l.[UniqueSubmissionID] AND i.[AuditId] = l.[AuditId]
	WHERE l.IsLatest = 1
)_

--Base table for Average Therapist Time per IET contact
IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
SELECT DISTINCT
	b.Month
	,b.PathwayID

	--Number of Appointments
    ,b.InternetEnabledTherapy_Count

	--Contact dates
	,i.StartDateIntEnabledTherLog

	--Therapist Time
	,i.DurationIntEnabledTher

	,IntEnabledTherProg

	,CASE WHEN i.LatestContactRank=1 OR i.LatestContactRank IS NULL THEN b.CompTreatFlag ELSE NULL 
	END AS CompTreatFlag --Flag for completed treatment flag, where the discharge date is within the reporting period
    
    --Geography
    ,b.[Sub-ICBCode]
	,b.[Sub-ICBName]
	,b.ICBCode
	,b.ICBName
	,b.RegionNameComm
	,b.RegionCodeComm
	,b.ProviderCode
	,b.ProviderName
	,b.RegionNameProv
INTO [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
FROM [MHDInternal].[TEMP_TTAD_IET_Base] b
LEFT JOIN [MHDInternal].[TEMP_TTAD_IET_IETContacts] i ON i.PathwayID = b.PathwayID 


IF OBJECT_ID ('[MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]') IS NOT NULL DROP TABLE [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
--National, IET 1+
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,CAST('1+ IET' AS VARCHAR(50)) AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,IntEnabledTherProg
GO

--National, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'National' AS OrgType
,'All Regions' AS Region
,'England' AS OrgName
,'ENG' AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,IntEnabledTherProg


--National, IET 2+
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'National' AS OrgType
,'All Regions' AS Region
,'England' AS OrgName
,'ENG' AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,IntEnabledTherProg

--Region, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm AS OrgName
,RegionCodeComm AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm
	,IntEnabledTherProg


--Region, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg


--Region, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg

--ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg

--ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--Sub-ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Provider, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgIETTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(DurationIntEnabledTher) AS AvgIETTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgIETContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg
















---------------------------------------------------------



--For all contacts average therapist time per contact
IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_AllContacts]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_AllContacts]
SELECT
*
,ROW_NUMBER() OVER(PARTITION BY PathwayID ORDER BY CareContDate desc) as LatestContactRank
INTO [MHDInternal].[TEMP_TTAD_IET_AllContacts]
FROM(
SELECT DISTINCT
    c.PathwayID
	,c.CareContDate
    ,ca.ClinContactDurOfCareAct
	,c.Unique_MonthID
FROM [mesh_IAPT].[IDS201carecontact] c
INNER JOIN [mesh_IAPT].[IsLatest_SubmissionID] l ON c.[UniqueSubmissionID] = l.[UniqueSubmissionID] AND c.[AuditId] = l.[AuditId]
LEFT JOIN [mesh_IAPT].[IDS202careactivity] ca ON ca.PathwayID=c.PathwayID AND ca.UniqueSubmissionID=c.UniqueSubmissionID
AND ca.AuditId=c.AuditId
WHERE l.IsLatest = 1
)_

IF OBJECT_ID ('[MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]') IS NOT NULL DROP TABLE [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
SELECT DISTINCT
	b.Month
	,b.PathwayID

	--Number of Appointments
    ,b.InternetEnabledTherapy_Count

	--Contact dates
	,ca.CareContDate

	--Therapist Time
	,ca.ClinContactDurOfCareAct

	,IntEnabledTherProg

	,CASE WHEN ca.LatestContactRank=1 OR ca.LatestContactRank IS NULL THEN b.CompTreatFlag ELSE NULL 
	END AS CompTreatFlag --Flag for completed treatment flag, where the discharge date is within the reporting period
    
    --Geography
    ,b.[Sub-ICBCode]
	,b.[Sub-ICBName]
	,b.ICBCode
	,b.ICBName
	,b.RegionNameComm
	,b.RegionCodeComm
	,b.ProviderCode
	,b.ProviderName
	,b.RegionNameProv
INTO [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
FROM [MHDInternal].[TEMP_TTAD_IET_Base] b
LEFT JOIN [MHDInternal].[TEMP_TTAD_IET_AllContacts] ca ON ca.PathwayID=b.PathwayID


----------
IF OBJECT_ID ('[MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]') IS NOT NULL DROP TABLE [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
--National, IET 1+
SELECT 
Month
,CAST('National' AS VARCHAR(50)) AS OrgType
,CAST('All Regions' AS VARCHAR(255)) AS Region
,CAST('England' AS VARCHAR(255)) AS OrgName
,CAST('ENG' AS VARCHAR(50)) AS OrgCode
,CAST('1+ IET' AS VARCHAR(50)) AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,IntEnabledTherProg
GO

--National, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'National' AS OrgType
,'All Regions' AS Region
,'England' AS OrgName
,'ENG' AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,IntEnabledTherProg


--National, IET 2+
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'National' AS OrgType
,'All Regions' AS Region
,'England' AS OrgName
,'ENG' AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,IntEnabledTherProg

--Region, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm AS OrgName
,RegionCodeComm AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm
	,IntEnabledTherProg


--Region, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg


--Region, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Region' AS OrgType
,RegionNameComm AS Region
,RegionNameComm  AS OrgName
,RegionCodeComm  AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,RegionCodeComm 
	,IntEnabledTherProg

--ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg

--ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'ICB' AS OrgType
,RegionNameComm AS Region
,[ICBName] AS OrgName
,[ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[ICBName]
	,[ICBCode]
	,IntEnabledTherProg


--Sub-ICB, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Sub-ICB, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Sub-ICB' AS OrgType
,RegionNameComm AS Region
,[Sub-ICBName] AS OrgName
,[Sub-ICBCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameComm
	,[Sub-ICBName]
	,[Sub-ICBCode]
	,IntEnabledTherProg

--Provider, 1+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'1+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=1
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, No IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'No IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count=0 OR InternetEnabledTherapy_Count IS NULL
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg

--Provider, 2+ IET
INSERT INTO [MHDInternal].[DASHBOARD_TTAD_IET_AvgAnyTherapistTime]
SELECT 
Month
,'Provider' AS OrgType
,RegionNameProv AS Region
,[ProviderName] AS OrgName
,[ProviderCode] AS OrgCode
,'2+ IET' AS AppointmentType
,IntEnabledTherProg
,AVG(ClinContactDurOfCareAct) AS AvgAnyTherapistTime
,SUM(CompTreatFlag) AS CompTreatFlag
FROM [MHDInternal].[TEMP_TTAD_IET_AvgAllContactBase]
WHERE InternetEnabledTherapy_Count>=2
GROUP BY 
	Month
	,RegionNameProv
	,[ProviderName]
	,[ProviderCode]
	,IntEnabledTherProg
